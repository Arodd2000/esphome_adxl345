substitutions:
  pin_rtttl_out: GPIO27
  rtttl_format_mario: "mario:d=4,o=5,b=120:16e6,16e6,32p,8e6,16c6,8e6,8g6,8p,8g,8p,8c6,16p,8g,16p,8e,16p,8a,8b,16a#,8a,16g.,16e6,16g6,8a6,16f6,8g6,8e6,16c6,16d6,8b,16p,8c6,16p,8g,16p,8e,16p,8a,8b,16a#,8a,16g.,16e6,16g6,8a6,16f6,8g6,8e6,16c6,16d6,8b,8p" #,16g6,16f#6,16f6,16d#6,16p,16e6,16p,16g#,16a,16c6,16p,16a,16c6,16d6,8p,16g6,16f#6,16f6,16d#6,16p,16e6,16p,16c7,16p,16c7,16c7,p,16g6,16f#6,16f6,16d#6,16p,16e6,16p,16g#,16a,16c6,16p,16a,16c6,16d6,8p,16d#6,8p,16d6,8p,16c6"
  rtttl_format_beep: "long:d=1,o=5,b=100:e6"
  rtttl_format_double_beep: "two short:d=4,o=5,b=100:16e6,16e6"
  rtttl_format_siren: "siren:d=8,o=5,b=100:d,e,d,e,d,e,d,e"
  battery_level_low_value: "30.0"
  battery_level_normal_value: "60.0"

output:
  - platform: ledc
    pin: ${pin_rtttl_out}
    id: rtttl_out

rtttl:
  output: rtttl_out

script:
  - id: rtttl_mario
    mode:  restart
    then:
      - if:
          condition:
            rtttl.is_playing
          then:
            - rtttl.stop
      - rtttl.play: ${rtttl_format_mario}

  - id: rtttl_beep
    then:
      - if:
          condition:
            rtttl.is_playing
          then:
            - rtttl.stop
      - rtttl.play: ${rtttl_format_beep}

  - id: rtttl_double_beep
    then:
      - if:
          condition:
            rtttl.is_playing
          then:
            - rtttl.stop
      - rtttl.play: ${rtttl_format_double_beep}

  - id: rtttl_siren
    then:
      - if:
          condition:
            rtttl.is_playing
          then:
            - rtttl.stop
      - rtttl.play: ${rtttl_format_siren}

binary_sensor:
  - platform: template
    id: battery_level_low
    lambda: |-
      if (id(ble_battery_level).state < ${battery_level_low_value} && !id(battery_level_low).state) {
        return true;
      } else if (id(ble_battery_level).state >= ${battery_level_normal_value} && id(battery_level_low).state) {
        return false;
      } else {
        return {};
      }
    on_press:
      script.execute: rtttl_siren

